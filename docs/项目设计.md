# 终端命令与工具管理系统项目设计

## 1. 项目概述
终端命令与工具管理系统是一个Go语言开发的跨平台工具集，提供三个专用工具：

- **cmmd** - 命令管理工具，用于管理xlsx格式的命令库
- **tool** - 离线工具管理工具，用于管理JSON格式的离线工具
- **web** - 网页工具管理工具，用于管理JSON格式的网页工具

通过这些工具，用户可以通过标签、关键词和描述来组织和检索命令，大大提高终端操作效率。

## 2. 系统架构
- **核心模块**：命令解析、数据加载、搜索引擎、命令复制粘贴、交互界面、显示布局
- **存储方式**：
  - xlsx格式的命令库（cmmd工具）
  - JSON格式的离线工具库（tool工具）
  - JSON格式的网页工具库（web工具）
- **输入输出**：命令行交互，支持彩色输出和Grid布局显示

## 3. 技术选择
- **开发语言**：Go (高性能、跨平台、编译为单一二进制文件)
- **依赖库**：
  - `github.com/excelize`：处理xlsx文件
  - `github.com/spf13/cobra`：命令行界面
  - `github.com/fatih/color`：彩色终端输出
  - `github.com/manifoldco/promptui`：交互式命令选择
  - `github.com/atotto/clipboard`：剪贴板操作
  - `github.com/eiannone/keyboard`：终端键盘事件捕获

## 4. 功能模块设计

### 4.1 配置管理
- 支持记住上次使用的文件路径
- 每个工具独立的配置文件
- 自定义工具路径配置

### 4.2 数据管理
- 命令库结构：序号、工具名、命令、标签、描述
- 离线工具结构：ID、名称、分类、路径、描述、标签、命令、URL
- 网页工具结构：ID、标题、URL、来源、工具、标签、笔记
- 只读模式，不支持在程序内修改数据源

### 4.3 搜索引擎
- 模糊搜索算法 (支持部分匹配和不完整关键词)
- 多条件组合搜索
- 搜索结果按相关性排序

### 4.4 命令执行
- 在交互模式中选中命令后，复制选中命令，退出交互模式，自动粘贴到终端中
- 通过序号(@<序号>)快速复制指定的命令并粘贴到终端中
- 支持多平台自动粘贴 (macOS、Linux、Windows)
- 提供详细的错误诊断和提示信息

### 4.5 交互界面
- 实时搜索和筛选（根据输入内容立即显示匹配结果）
- 命令预览
- 支持键盘导航和快捷键

### 4.6 显示布局系统
- **Grid布局**：用于标签和工具统计的显示
- 动态列宽计算，适应不同内容
- 精确处理中英文混合文本的宽度差异
- 自适应终端宽度调整列数
- 统一的间距和对齐方式

### 4.7 彩色输出规则
- **序号**：灰色（暗色背景）/ 浅灰色（亮色背景）
- **工具名**：蓝色加粗
- **命令**：绿色
- **标签**：黄色带方括号 [标签1][标签2]
- **描述**：白色（暗色背景）/ 黑色（亮色背景）
- **匹配关键词**：黄色背景高亮
- **交互提示**：青色
- **错误信息**：红色
- **成功消息**：亮绿色
- **统计信息**：亮蓝色

## 5. 命令行接口设计

### 5.1 通用命令格式

```
# 基础命令
<工具名> -h/--help        # 显示帮助信息
<工具名> -v/--version     # 显示版本信息

# 统计命令
<工具名> -T/--showtags    # 显示所有标签及其统计信息
<工具名> -C/--showcommands # 显示所有工具名及其统计信息

# 快速粘贴
<工具名> @<序号>          # 复制指定序号的命令并粘贴到终端中

# 交互模式
<工具名>                  # 进入交互模式（自动加载上次使用的文件）
```

### 5.2 工具特定命令

```
# cmmd 工具
cmmd -l <xlsx路径>     # 加载命令库

# tool 工具
tool -o <json路径>     # 加载离线工具库

# web 工具
web -w <json路径>      # 加载网页工具库
```

## 6. 数据流程

### 6.1 启动流程
- 确定当前工具类型（cmmd/tool/web）
- 加载上次使用的文件路径
- 根据工具类型加载相应数据源
- 验证数据完整性
- 显示加载信息和统计

### 6.2 搜索流程
- 解析搜索参数
- 执行搜索算法
- 根据相关性排序结果
- 格式化并输出结果

### 6.3 交互执行流程
- 用户在交互模式中选择命令
- 系统复制选中命令到剪贴板
- 优雅退出交互模式，返回到终端
- 自动粘贴命令到终端光标位置
- 用户可手动按回车执行命令

### 6.4 复制粘贴流程
- 解析序号参数
- 查找对应命令
- 复制命令到剪贴板
- 等待短暂时间确保复制完成
- 模拟键盘事件粘贴到终端
- 提供详细的错误诊断信息
- 反馈操作结果

### 6.5 Grid布局渲染流程
- 收集要显示的项目（标签或工具）
- 计算每个项目的显示宽度（考虑中英文字符差异）
- 根据终端宽度确定最佳列数
- 计算每列的最大宽度
- 渲染网格，确保每列对齐
- 添加适当的间距和换行

## 7. 用户体验设计

- 一致的彩色输出增强可读性和交互体验
- 使用方括号统一格式化各元素: [ID] [工具] [命令] [标签]
- 交互模式下实时显示匹配结果
- 清晰的搜索结果展示格式
- Grid布局显示统计信息，提高可读性
- 粘贴成功时给予用户明确反馈
- 全面的错误处理和诊断信息

## 8. 交互模式详细设计

- **启动**：输入工具名进入交互模式
- **实时搜索**：
  - 用户输入关键词时立即显示匹配结果
  - 支持用空格或逗号分隔多个关键词进行组合搜索
  - 空格和逗号可以混合使用，例如：`git clone,pull status`
- **导航**：
  - Tab键/方向键在结果间导航
  - 回车键选择命令，随后：
    - 复制命令到剪贴板
    - 退出交互模式
    - 自动粘贴命令到终端
  - q键退出交互模式（不选择命令）
- **显示格式**：
  - 按照统一彩色规则显示各元素
  - 多结果时清晰区分每条命令
  - 当前选中项有明确的视觉指示
- **快捷操作**：
  - 在交互模式中输入`@<序号>`快速粘贴命令到终端

## 9. 技术挑战与解决方案

### 9.1 退出交互模式后粘贴到终端
- **挑战**: 程序退出后如何继续控制终端
- **解决方案**: 
  - 使用剪贴板作为中间媒介
  - 根据不同操作系统实现专用的粘贴机制:
    - macOS: 使用AppleScript模拟Command+V
    - Linux: 使用xdotool模拟Ctrl+V，回退到xclip
    - Windows: 使用PowerShell SendKeys模拟Ctrl+V
  - 添加适当延迟确保命令完成执行

### 9.2 跨平台兼容性
- **挑战**: 不同操作系统的终端行为差异
- **解决方案**:
  - 为各主要平台(Linux/macOS/Windows)实现专用的粘贴机制
  - 添加回退机制，当自动粘贴失败时提供操作指导
  - 提供详细的错误信息帮助诊断问题

### 9.3 中英文混合显示对齐问题
- **挑战**: 中英文字符宽度不同导致显示对齐问题
- **解决方案**:
  - 实现Grid布局系统，精确计算文本显示宽度
  - 考虑中文字符占用两个宽度单位的特性
  - 动态调整列数和列宽以适应不同内容
  - 使用固定空格间距替代制表符，提高对齐稳定性

### 9.4 Shell特殊字符处理
- **挑战**: Shell会解释某些特殊字符(如!用于历史展开)
- **解决方案**:
  - 使用@替代!作为快速访问前缀
  - 在错误处理中提供清晰的诊断信息
  - 确保所有用户界面一致地使用新前缀

## 10. 错误处理和诊断

### 10.1 常见错误类型
- 文件不存在或格式错误
- 命令序号不存在
- 剪贴板操作失败
- 自动粘贴失败
- 显示对齐问题

### 10.2 错误处理策略
- 提供具体、可操作的错误信息
- 在粘贴失败时显示详细的错误原因
- 显示所有可用的命令ID辅助诊断
- 在自动粘贴失败时提供手动操作指导
- 对显示问题提供调整建议

## 11. 自定义工具路径配置

### 11.1 macOS 配置方法
- 创建个人工具目录（~/my_tools）
- 配置环境变量（~/.zshrc 或 ~/.bashrc）
- 复制工具到个人目录并设置执行权限

### 11.2 Windows 配置方法
- 创建个人工具目录（%USERPROFILE%\my_tools）
- 添加到系统环境变量（PATH）
- 复制工具到个人目录

### 11.3 Linux 配置方法
- 创建个人工具目录（~/my_tools）
- 配置环境变量（~/.bashrc 或 ~/.zshrc）
- 复制工具到个人目录并设置执行权限

## 12. 优化和完善建议

### 12.1 命令历史记录
- 记录用户使用过的命令及频率
- 根据历史使用频率优化搜索结果排序
- 提供命令使用情况的统计和分析

### 12.2 终端识别与优化
- 自动识别当前终端类型
- 为不同终端环境优化显示和粘贴机制

### 12.3 命令标签自动建议
- 基于命令内容智能推荐标签
- 提供标签统一性和一致性检查

### 12.4 命令编辑功能
- 添加命令编辑界面
- 支持在应用内更新数据源

### 12.5 配置文件支持
- 添加用户配置文件
- 支持自定义颜色方案和显示格式

### 12.6 性能优化
- 实现增量读取大型命令库
- 提供后台索引和缓存机制

### 12.7 更多显示布局选项
- 提供紧凑模式和详细模式
- 支持自定义Grid布局参数
- 优化超长文本的处理方式

## 13. 构建系统设计

### 13.1 多平台构建系统
- **构建脚本**：
  - `build.sh` (Linux/macOS)
  - `build.bat` (Windows)
- **支持的平台**：
  - darwin/amd64 (macOS Intel)
  - darwin/arm64 (macOS Apple Silicon)
  - linux/amd64 (Linux x86_64)
  - linux/arm64 (Linux ARM64)
  - windows/amd64 (Windows x64)
- **构建模式**：
  - 本地编译模式 (`--local-only` 参数)
  - 多平台编译模式 (默认)
- **输出目录结构**：
  - 当前平台：项目根目录
  - 多平台：`build/<GOOS>_<GOARCH>/` 目录
- **构建流程**：
  1. 确定构建模式（本地或多平台）
  2. 本地平台编译（必须成功）
  3. 如果是多平台模式，遍历所有目标平台
  4. 为每个平台设置环境变量并编译
  5. 输出编译结果到对应目录

### 13.2 帮助信息显示设计
- **统一对齐系统**：
  - 使用固定起始位置显示右侧描述文本
  - 精确计算中英文混合文本的显示宽度
  - 动态调整间距确保对齐
- **帮助信息分类**：
  - 配置命令（加载数据源、显示版本等）
  - 搜索命令（关键词、标签、工具名等）
  - 统计命令（显示标签和工具名统计）
  - 快捷操作（使用@序号快速访问）
  - 使用示例
- **颜色编码**：
  - 命令：绿色
  - 描述：白色
  - 标题：亮青色加粗
  - 分节标题：亮紫色
- **工具特定内容**：
  - 根据工具类型(cmmd/tool/web)动态调整帮助内容
  - 保持一致的格式和风格

